---
title: "Variable Importance and Partial Dependence Plots"
subtitle: "MERRA Covariate Model"
output: html_document
---

Subsetted to California 2017-2020 and fit linear regression, random forest, and
gradient boosted trees models to predict smoke PM2.5 from covariates. Here just 
looking at variable importance and partial dependence plots.

```{r include = FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(echo = FALSE)

path_project <- "~/BurkeLab Dropbox/Projects/smoke_PM_prediction/complex_MERRA_model/"
path_results <- "~/Documents/GitHub/smoke_PM_prediction/work/06_complex_MERRA_model/results/"

library(fixest)
library(ranger)
library(gbm)
library(dplyr)
library(vip)
library(pdp)
library(sparkline)

# Load models
mdl_ln <- readRDS(paste0(path_results, "model_covariates_linear.rds"))
mdl_rf <- readRDS(paste0(path_results, "model_covariates_random_forest.rds"))
mdl_gb <- readRDS(paste0(path_results, "model_covariates_gradient_boosted_trees.rds"))

# Load training data
dat_train_full <- readRDS(paste0(path_project, "dat_train.rds"))
```

### Linear Model

\begin{aligned}
smokePM \sim &aot_{anom} \times smokeday + smokeday + \\
&aot_{anom} \times smokeday \times kmdist + smokeday \times kmdist + \\
&aot_{anom} \times smokeday \times elevation + smokeday \times elevation + \\
&aot_{anom} \times smokeday \times pbl_{min} + smokeday \times pbl_{min} + \\
&aot_{anom} \times smokeday \times temperature + smokeday \times temperature + \\
&aot_{anom} \times smokeday \times precipitation + smokeday \times precipitation
\end{aligned}

and FEs for station ID, year, and month.

```{r}
# Select features in linear model
dat_train <- dat_train_full %>% 
  select(smokePM, smoke_day, aot_anom, km_dist, elevation, pbl_min, temperature,
         precipitation, epa_id, month, year)

# Plot variable importance and partial dependence for linear regression model
set.seed(7568)
vi_ln <- vi(mdl_ln, method = "permute", target = "smokePM", metric = "rmse", 
            pred_wrapper = predict, nsim = 10)
add_sparklines(vi_ln, fit = mdl_ln)
```

```{r}
# Select features in ML models
dat_train <- dat_train_full %>% 
  select(smokePM, smoke_day, aot_anom, precipitation, temperature, pbl_min, 
         km_dist, elevation, wind_u, wind_v, month, year, lon, lat)
```

### Random Forest Model

Formula for both random forest and gradient boosted trees:
\begin{aligned}
smokePM \sim &smokeday + aot_{anom} + \\
&precipitation + temperature + \\
&pbl_{min} + kmdist + elevation + \\
&wind_u + wind_v + \\
&month + year + lon + lat
\end{aligned}

```{r}
# THIS TAKES ~10 MINUTES
# Plot variable importance and partial dependence for random forest model
vi_rf <- vi(mdl_rf)
add_sparklines(vi_rf, mdl_rf)
```

### Gradient Boosted Trees Model

```{r}
# Plot variable importance and partial dependence for gradient boosted trees model
vi_gb <- vi(mdl_gb)
add_sparklines(vi_gb, mdl_gb, n.trees = 5000)
```
